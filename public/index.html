<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TREC BioGen 2025 — Task B Viewer (Vercel)</title>
  <style>
    :root{
      --bg:#0d0f1a; --bg2:#10142a; --card:#141a33; --text:#e8ecff; --muted:#a7b4dd;
      --accent:#7c3aed; --accent-weak:#32215a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      color:var(--text); background:#0d0f1a;
    }
    header{position:sticky;top:0;z-index:10;padding:20px 24px;border-bottom:1px solid #1e2746;background:rgba(13,15,26,.7);backdrop-filter:blur(6px)}
    h1{margin:0;font-size:22px}
    .nav{display:flex;gap:14px;align-items:center;flex-wrap:wrap;font-size:14px;color:var(--muted)}
    .nav a{color:#cdb8ff;text-decoration:none}
    .nav a:hover{text-decoration:underline}

    .container{max-width:1100px;margin:0 auto;padding:16px 24px 24px}

    #landing{
      position:relative;height:72vh;display:flex;align-items:center;justify-content:center;overflow:hidden
    }
    #anim{
      position:absolute;inset:0;background:
        radial-gradient(40% 60% at 20% 10%, #1b1f46 0%, transparent 60%),
        radial-gradient(40% 50% at 80% 0%, #2a2160 0%, transparent 60%),
        radial-gradient(30% 60% at 60% 90%, #151b44 0%, transparent 60%),
        radial-gradient(20% 30% at 10% 80%, #2c114b 0%, transparent 60%);
      filter:blur(30px);animation:float 16s ease-in-out infinite alternate
    }
    @keyframes float{to{transform:translateY(-20px) scale(1.02)}}
    .hero{position:relative;text-align:center}
    .hero h2{font-size:40px;margin:0 0 8px}
    .hero p{color:var(--muted);margin:0 0 18px}
    .hero .cta{
      font-size:16px;padding:10px 16px;border-radius:12px;border:1px solid #2a3560;
      background:linear-gradient(90deg,#2b1e52,#291e68);color:#fff;cursor:pointer
    }
    .hero .cta:hover{box-shadow:0 0 0 3px rgba(124,58,237,.25)}

    .panel{background:var(--card);border:1px solid #1f284c;border-radius:16px;padding:20px;margin-bottom:18px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a3560;background:#0f1430;color:var(--text)}
    input[type="text"]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,.25)}
    .systems{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid #2a3560;background:#0f1430;cursor:pointer}
    .chip input{accent-color:var(--accent)}
    .muted{color:var(--muted);font-size:13px}

    .result{border-top:1px solid #202a52;padding-top:16px;margin-top:16px}
    .qid{font-weight:700;font-size:12px;color:var(--muted)}
    .qt{font-size:18px;font-weight:800;margin:6px 0 4px}
    .topic{font-size:13px;color:var(--muted)}
    details{margin-top:8px} summary{cursor:pointer;color:var(--muted)}

    .answers{margin-top:14px}
    .card{background:#101739;border:1px solid #23306a;border-radius:12px;padding:14px}
    .sys{font-weight:800;margin-bottom:10px;font-size:13px}

    .ans{line-height:1.65}
    .srow{margin:10px 0;padding:10px 12px;background:#0f1430;border:1px solid #2a3560;border-radius:10px}
    .srow .bullet{display:inline-block;width:8px;height:8px;border-radius:50%;background:#7c3aed;margin-right:8px;transform:translateY(-1px)}
    .srow .text{display:inline}
    .srow .actions{display:inline-flex;gap:8px;margin-left:8px}
    .btn{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2a3560;background:var(--bg2);color:var(--text);cursor:pointer}
    .btn:hover{background:var(--accent-weak);border-color:var(--accent)}

    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
    .tab{padding:6px 10px;border-radius:10px;border:1px solid #2a3560;background:#0f1430;cursor:pointer}
    .tab.active{background:#271a51;border-color:#7c3aed}
    .tabcontent{display:none}
    .tabcontent.active{display:block}

    .spinner-wrap{display:flex;gap:10px;align-items:center;justify-content:center;padding:24px}
    .spinner{width:16px;height:16px;border-radius:50%;border:3px solid #263154;border-top-color:#b392ff;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .select{border:1px solid #2a3560;background:#0f1430;color:var(--text);border-radius:8px;padding:6px 8px}

    .footer{text-align:center;color:var(--muted);padding:26px 24px;font-size:13px}
    .footer a{color:#cdb8ff}
  </style>
</head>
<body>
    <header>
      <div class="container">
        <div class="nav">
          <h1 style="margin-right:auto;">TREC BioGen 2025 — Task B Viewer</h1>
          <a href="#home" id="navHome">Home</a>
          <a href="#viewer" id="navViewer">Viewer</a>
          <a href="https://github.com/cbsag/trec-biogen-taskb-viewer" target="_blank" rel="noopener">GitHub</a>
          <a href="https://www.linkedin.com/in/your-link" target="_blank" rel="noopener">LinkedIn</a>
        </div>
      </div>
    </header>
  
    <section id="landing">
      <div id="anim"></div>
      <div class="hero">
        <h2>Biomedical QA, grounded & comparable</h2>
        <p>Explore 30 TREC BioGen Task-B topics and compare system answers sentence-by-sentence with PubMed citations.</p>
        <button class="cta" id="openViewerBtn">Open Viewer</button>
      </div>
    </section>
    
    <div class="container" id="viewer" style="display:none">
      <div class="panel">
        <div class="row">
          <div class="grow"><input id="q" type="text" placeholder="Search by ID, question, topic, or narrative… (e.g., ‘axonal injury’ or ‘181’)" /></div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="systems" id="systems"></div>
          <label class="chip" title="Automatically query PubMed for the first few sentences (rate-limited)">
            <input type="checkbox" id="autoCiteToggle" />
            <span>Auto-cite sentences (PubMed)</span>
          </label>
          <div class="toolbar">
            <label class="muted">View</label>
            <select id="viewMode" class="select">
              <option value="auto" selected>Auto (Tabs if multiple)</option>
              <option value="tabs">Tabs</option>
              <option value="columns">Columns</option>
            </select>
            <label class="muted">Text size</label>
            <select id="textSize" class="select">
              <option value="1.55">Comfort</option>
              <option value="1.65" selected>Relaxed</option>
              <option value="1.8">Spacious</option>
            </select>
          </div>
          <div class="muted" id="meta" style="margin-top:6px"></div>
        </div>
        <div id="results"></div>
      </div>
    </div>
  <!-- <div class="container" id="viewer">
    <div class="panel">
      <div class="row">
        <div class="grow">
          <input id="q" type="text" placeholder="Search by ID, question, topic, or narrative… (e.g., 'axonal injury' or '181')" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="systems" id="systems"></div>
        <label class="chip" title="Automatically query PubMed for each sentence (rate-limited).">
          <input type="checkbox" id="autoCiteToggle" />
          <span>Auto‑cite sentences (PubMed)</span>
        </label>
      </div>
      <div class="muted" id="meta" style="margin-top:8px"></div>
    </div>

    <div id="results"></div>
  </div>

 <div class="footer">
  ~ cbsag ·
  <a href="https://github.com/cbsag" target="_blank" rel="noopener">GitHub</a> ·
  <a href="https://www.linkedin.com/in/cbsag" target="_blank" rel="noopener">LinkedIn</a>
</div> -->

  <script>
    const systemsDiv = document.getElementById("systems");
    const resultsDiv = document.getElementById("results");
    const metaDiv = document.getElementById("meta");
    const qInput = document.getElementById("q");

    let allSystems = [];
    let sysDescriptions = {};
    let autoCite = false;
    const AUTO_CITE_PER_ANSWER_LIMIT = 3;  // limit per system answer card
    const AUTO_CITE_RETMAX = 3;             // top N PubMed matches per sentence

    const landing = document.getElementById('landing');
    const viewer = document.getElementById('viewer');
    const openBtn = document.getElementById('openViewerBtn');
    const navHome = document.getElementById('navHome');
    const navViewer = document.getElementById('navViewer');
    const textSizeSel = document.getElementById('textSize');
    const viewModeSel = document.getElementById('viewMode');

    function showViewer() {
      landing.style.display = 'none';
      viewer.style.display = 'block';
      qInput.focus();
    }
    function showLanding() {
      viewer.style.display = 'none';
      landing.style.display = 'flex';
    }
    openBtn.addEventListener('click', showViewer);
    navViewer.addEventListener('click', (e)=>{ e.preventDefault(); showViewer(); });
    navHome.addEventListener('click', (e)=>{ e.preventDefault(); showLanding(); });

    document.addEventListener('keydown', (e)=>{
      if (e.key === '/') { showViewer(); qInput.focus(); e.preventDefault(); }
    });

    textSizeSel.addEventListener('change', ()=>{
      document.querySelectorAll('.ans').forEach(a => a.style.lineHeight = textSizeSel.value);
    });

    function selectedSystems() {
      return Array.from(document.querySelectorAll('.chip input[type="checkbox"]:checked')).map(cb => cb.value);
    }

    function renderSystems() {
      systemsDiv.innerHTML = "";
      allSystems.forEach(sys => {
        const chip = document.createElement("label");
        chip.className = "chip";
        const desc = (sysDescriptions[sys]||"").replace(/"/g,'&quot;');
        chip.innerHTML = `
          <input type="checkbox" value="${sys}" checked />
          <span>${sys}</span>
          <span class="muted" title="${desc}">ⓘ</span>
        `;
        systemsDiv.appendChild(chip);
        chip.querySelector("input").addEventListener("change", doSearch);
      });
    }

    async function fetchSystems() {
      const r = await fetch("/api/systems");
      const data = await r.json();
      allSystems = data.systems || [];
      sysDescriptions = data.descriptions || {};
      renderSystems();
    }

    function splitSentences(text) {
      if (!text) return [];
      // Split by punctuation + whitespace while keeping abbreviations somewhat safe
      // This is a simple splitter; for biomedical text it's okay for UI purposes.
      const parts = text
        .replace(/\s+/g, ' ')
        .split(/(?<=[\.!?])\s+(?=[A-Z0-9])/g);
      return parts.filter(s => s && s.trim());
    }

    // async function fetchCites(sentence, retmax=5) {
    //   const url = `/api/cite?sentence=${encodeURIComponent(sentence)}&retmax=${retmax}`;
    //   const r = await fetch(url);
    //   if (!r.ok) throw new Error(`Citation search failed (${r.status})`);
    //   return await r.json();
    // }

    // function renderCitations(container, sentence, retmax=5) {
    //   container.innerHTML = '<span class="muted">searching…</span>';
    //   fetchCites(sentence, retmax).then(data => {
    //     if (!data.citations || !data.citations.length) {
    //       container.innerHTML = '<span class="muted">no PubMed matches</span>';
    //       return;
    //     }
    //     const ul = document.createElement('ul');
    //     ul.style.margin = '6px 0 0 0';
    //     ul.style.paddingLeft = '18px';
    //     data.citations.forEach(c => {
    //       const li = document.createElement('li');
    //       const link = document.createElement('a');
    //       link.href = c.url;
    //       link.target = '_blank';
    //       link.rel = 'noopener';
    //       link.textContent = `${c.title} (${c.journal}${c.year? ', ' + c.year : ''})`;
    //       li.appendChild(link);
    //       if (c.doi) {
    //         const small = document.createElement('span');
    //         small.className = 'muted';
    //         small.style.marginLeft = '6px';
    //         small.textContent = `doi:${c.doi}`;
    //         li.appendChild(small);
    //       }
    //       ul.appendChild(li);
    //     });
    //     container.innerHTML = '';
    //     container.appendChild(ul);
    //   }).catch(err => {
    //     container.innerHTML = '<span class="muted">error fetching citations</span>';
    //   });
    // }
    let _citeCache = new Map();    // front-end cache by exact sentence
    const RATE_MS = 150;            // top N PubMed matches per
    let _citeQ = Promise.resolve(); // queue to serialize bursts

      async function fetchCites(sentence, retmax=5) {
        const key = `${sentence}::${retmax}`;
        if (_citeCache.has(key)) return _citeCache.get(key);
        const url = `/api/cite?sentence=${encodeURIComponent(sentence)}&retmax=${retmax}`;
        // queue it to respect rate
        _citeQ = _citeQ.then(() => new Promise((resolve) => setTimeout(resolve, RATE_MS)));
        await _citeQ;
        const r = await fetch(url);
        const data = await r.json().catch(() => ({}));
        _citeCache.set(key, data);
        return data;
      }

      function renderCitations(container, sentence, retmax=5) {
        container.innerHTML = '<span class="muted">searching…</span>';
        fetchCites(sentence, retmax).then(data => {
          if (data.error) {
            container.innerHTML = `<span class="muted">error: ${data.error}</span>`;
            return;
          }
          if (!data.citations || !data.citations.length) {
            container.innerHTML = '<span class="muted">no PubMed matches</span>';
            return;
          }
          const ul = document.createElement('ul');
          ul.style.margin = '8px 0 0 0';
          ul.style.paddingLeft = '18px';
          data.citations.forEach(c => {
            const li = document.createElement('li');
            const link = document.createElement('a');
            link.href = c.url; link.target = "_blank"; link.rel = "noopener";
            link.textContent = `${c.title} (${c.journal}${c.year ? ', ' + c.year : ''})`;
            li.appendChild(link);
            if (c.doi) {
              const small = document.createElement('span');
              small.className = 'muted'; small.style.marginLeft = '6px';
              small.textContent = `doi:${c.doi}`;
              li.appendChild(small);
            }
            ul.appendChild(li);
          });
          container.innerHTML = ''; container.appendChild(ul);
        }).catch(err => {
          container.innerHTML = `<span class="muted">error: ${String(err.message || err)}</span>`;
        });
      }
    
    function addPMIDsSection(card, item, sys) {
      const pmids = (item.pmids && item.pmids[sys]) || [];
      if (!pmids.length) return;

      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = `Cited PMIDs (${pmids.length})`;

      const slot = document.createElement('div');
      slot.className = 'muted';
      slot.style.marginTop = '8px';

      btn.addEventListener('click', () => renderPMIDList(slot, pmids));

      // place after sentences
      card.appendChild(btn);
      card.appendChild(slot);
    }
  
    function renderResults(data) {
      resultsDiv.innerHTML = "";
      metaDiv.textContent = `${data.count} result(s) • showing: ${data.systems.join(", ")}`;

      data.results.forEach(item => {
        const wrap = document.createElement("div");
        wrap.className = "panel result";

        // header
        const header = document.createElement("div");
        header.innerHTML = `
          <div class="qid">ID ${item.id}</div>
          <div class="qt">${item.question}</div>
          <div class="topic">Topic: ${item.topic || "—"}</div>
        `;
        wrap.appendChild(header);

        // narrative
        const det = document.createElement("details");
        const sum = document.createElement("summary");
        sum.textContent = "Show narrative";
        det.appendChild(sum);
        const p = document.createElement("div");
        p.className = "muted";
        p.style.marginTop = "8px";
        p.textContent = item.narrative || "—";
        det.appendChild(p);
        wrap.appendChild(det);

        // answers area
        const answersWrap = document.createElement("div");
        answersWrap.className = "answers";

        // systems with non-empty answers
        const sysList = Object.entries(item.answers).filter(([, text]) => text && text.trim());
        const multi = sysList.length > 1;
        const mode = viewModeSel.value === 'auto' ? (multi ? 'tabs' : 'single') : viewModeSel.value;

        if (!multi || mode === 'single') {
          // ONE big card
          const [sys, text] = sysList[0] || Object.entries(item.answers)[0] || ["System", ""];
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `<div class="sys">${sys}</div><div class="ans"></div>`;
          answersWrap.appendChild(card);
          populateSentences(card.querySelector('.ans'), text);
          addPMIDsSection(card, item, sys);

        } else if (mode === 'tabs') {
          // TABS
          const tabs = document.createElement('div'); tabs.className = 'tabs';
          const contents = document.createElement('div');

          sysList.forEach(([sys, text], idx) => {
            const t = document.createElement('button');
            t.className = 'tab' + (idx === 0 ? ' active' : '');
            t.textContent = sys;
            tabs.appendChild(t);

            const c = document.createElement('div');
            c.className = 'tabcontent' + (idx === 0 ? ' active' : '');
            const card = document.createElement('div'); card.className = 'card';
            card.innerHTML = `<div class="sys">${sys}</div><div class="ans"></div>`;
            c.appendChild(card);
            contents.appendChild(c);

            populateSentences(card.querySelector('.ans'), text);
            addPMIDsSection(card, item, sys);

            t.addEventListener('click', () => {
              tabs.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
              contents.querySelectorAll('.tabcontent').forEach(x => x.classList.remove('active'));
              t.classList.add('active'); c.classList.add('active');
            });
          });

          answersWrap.appendChild(tabs);
          answersWrap.appendChild(contents);

        } else {
          // COLUMNS
          const grid = document.createElement('div');
          grid.style.display = 'grid';
          grid.style.gridTemplateColumns = `repeat(${Math.min(sysList.length, 3)}, minmax(320px, 1fr))`;
          grid.style.gap = '16px';

          sysList.forEach(([sys, text]) => {
            const card = document.createElement('div'); card.className = 'card';
            card.innerHTML = `<div class="sys">${sys}</div><div class="ans"></div>`;
            grid.appendChild(card);
            populateSentences(card.querySelector('.ans'), text);
            addPMIDsSection(card, item, sys);
          });

          answersWrap.appendChild(grid);
        }

        wrap.appendChild(answersWrap);
        resultsDiv.appendChild(wrap);
      });
    }


    async function doSearch() {
      const q = qInput.value;
      const selected = selectedSystems();
      // resultsDiv.innerHTML = `<div class="spinner-wrap"><div class="spinner"></div><div class="muted">Loading answers…</div></div>`;
      resultsDiv.innerHTML = `<div class="spinner-wrap"><div class="spinner"></div><div class="muted">Loading answers…</div></div>`;

      const url = `/api/search?q=${encodeURIComponent(q)}&systems=${encodeURIComponent(selected.join(","))}`;
      const r = await fetch(url);
      const data = await r.json();
      renderResults(data);
    }

    qInput.addEventListener("input", () => {
      clearTimeout(window.__q_timer);
      window.__q_timer = setTimeout(doSearch, 120);
    });

    (async function init() {
      await fetchSystems();
      await doSearch();
      qInput.focus();
      const t = document.getElementById('autoCiteToggle');
      if (t) {
        const saved = localStorage.getItem('autoCite') === 'true';
        t.checked = saved; autoCite = saved;
        t.addEventListener('change', () => {
          autoCite = t.checked; localStorage.setItem('autoCite', String(autoCite));
          // re-run to annotate again if enabled
          doSearch();
        });
      }
    })();
    function populateSentences(ansDiv, text) {
      ansDiv.style.lineHeight = textSizeSel.value;
      if (!text) { ansDiv.innerHTML = "<span class='muted'>— no answer —</span>"; return; }
      const sents = splitSentences(text);
      sents.forEach((s, idx) => {
        const row = document.createElement('div'); row.className = 'srow';
        const dot = document.createElement('span'); dot.className = 'bullet';
        const span = document.createElement('span'); span.className = 'text'; span.textContent = s;
        const actions = document.createElement('span'); actions.className = 'actions';
        const btn = document.createElement('button'); btn.className = 'btn'; btn.textContent = 'Find PubMed cites';

        const slot = document.createElement('div'); slot.className = 'muted'; slot.style.marginTop = '6px';

        btn.addEventListener('click', ()=> renderCitations(slot, s, 5));
        actions.appendChild(btn);

        row.appendChild(dot); row.appendChild(span); row.appendChild(actions); row.appendChild(slot);
        ansDiv.appendChild(row);

        if (autoCite && idx < AUTO_CITE_PER_ANSWER_LIMIT) renderCitations(slot, s, AUTO_CITE_RETMAX);
      });
    }
    async function fetchPMIDsDetails(pmids) {
      const key = pmids.join(",");
      if (!window.__pmidCache) window.__pmidCache = new Map();
      if (window.__pmidCache.has(key)) return window.__pmidCache.get(key);
      const r = await fetch(`/api/pubmed?pmids=${encodeURIComponent(key)}`);
      const data = await r.json().catch(()=>({}));
      window.__pmidCache.set(key, data);
      return data;
    }

    function renderPMIDList(container, pmids) {
      container.innerHTML = '<span class="muted">loading citations…</span>';
      fetchPMIDsDetails(pmids).then(data => {
        if (data.error) { container.innerHTML = `<span class="muted">error: ${data.error}</span>`; return; }
        if (!data.items || !data.items.length) { container.innerHTML = '<span class="muted">no details returned</span>'; return; }
        const ul = document.createElement('ul');
        ul.style.margin = '8px 0 0 0'; ul.style.paddingLeft = '18px';

        data.items.forEach(p => {
          const li = document.createElement('li');
          const a = document.createElement('a'); a.href = p.url; a.target='_blank'; a.rel='noopener';
          a.textContent = `${p.title} (${p.journal}${p.year ? ', ' + p.year : ''})`;
          li.appendChild(a);
          if (p.doi) { const d = document.createElement('span'); d.className='muted'; d.style.marginLeft='6px'; d.textContent = `doi:${p.doi}`; li.appendChild(d); }

          if (p.abstract) {
            const det = document.createElement('details'); det.style.marginTop='6px';
            const sum = document.createElement('summary'); sum.textContent = 'Show abstract';
            const abs = document.createElement('div'); abs.className='muted'; abs.style.marginTop='6px'; abs.style.whiteSpace='pre-wrap'; abs.textContent = p.abstract;
            det.appendChild(sum); det.appendChild(abs);
            li.appendChild(det);
          }
          ul.appendChild(li);
        });
        container.innerHTML = ''; container.appendChild(ul);
      }).catch(err => { container.innerHTML = `<span class="muted">error: ${String(err.message || err)}</span>`; });
    }


  </script>
</body>
</html>
