<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TREC BioGen 2025 — Task B Viewer (Vercel)</title>
  <style>
        :root {
      --bg: #0d0f1a;        /* deeper night */
      --bg2: #10142a;
      --card: #141a33;
      --text: #e8ecff;
      --muted: #a7b4dd;
      --accent: #7c3aed;    /* purple */
      --accent-weak: #32215a;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial;
      background: radial-gradient(80% 60% at 50% -10%, #131939, #0d0f1a);
      color: var(--text);
    }

    header {
      padding: 26px 24px 10px 24px;
      border-bottom: 1px solid #1e2746;
      position: sticky; top: 0;
      backdrop-filter: blur(6px);
      background: rgba(13,15,26,0.7);
    }

    h1 { margin: 0 0 6px 0; font-size: 22px; letter-spacing: 0.2px; }
    .nav {
      display:flex; gap:14px; align-items:center; flex-wrap:wrap;
      font-size: 14px; color: var(--muted);
    }
    .nav a { color: #cdb8ff; text-decoration:none; }
    .nav a:hover { text-decoration:underline; }

    .container { max-width: 1100px; margin: 0 auto; padding: 16px 24px 24px 24px; }
    .hero {
      margin: 8px 0 14px 0;
      color: var(--muted);
    }

    .panel {
      background: var(--card);
      border: 1px solid #1f284c;
      border-radius: 16px;
      padding: 20px; margin-bottom: 18px;
    }

    .row { display:flex; gap: 12px; flex-wrap:wrap; }
    .grow { flex: 1; }

    input[type="text"] {
      width: 100%; padding: 12px 14px; border-radius: 12px;
      border: 1px solid #2a3560; background: #0f1430; color: var(--text);
      outline:none; line-height: 1.4;
    }
    input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,58,237,0.25); }

    .systems { display:flex; gap:8px; flex-wrap:wrap; }
    .chip {
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border-radius:999px; border:1px solid #2a3560;
      background: #0f1430; user-select:none; cursor:pointer;
    }
    .chip input { accent-color: var(--accent); }

    .muted { color: var(--muted); font-size: 13px; }

    .result { border-top: 1px solid #202a52; padding-top: 16px; margin-top: 16px; }
    .qid { font-weight:700; font-size:12px; color: var(--muted); }
    .qt { font-size: 18px; font-weight: 700; margin: 6px 0 4px 0; }
    .topic { font-size: 13px; color: var(--muted); }

    details { margin-top: 8px; }
    summary { cursor:pointer; color: var(--muted); }

    .answers {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px; margin-top: 14px;
    }
    .card {
      background: #101739; border: 1px solid #23306a; border-radius: 12px; padding: 14px;
    }
    .sys { font-weight: 800; margin-bottom: 10px; font-size: 13px; }

    .ans { line-height: 1.6; }
    .srow { margin: 10px 0; padding: 8px 10px; background: #0f1430; border: 1px solid #2a3560; border-radius: 10px; }
    .srow .text { display:inline-block; }
    .srow .actions { display:inline-flex; align-items:center; gap:8px; margin-left: 8px; }
    .btn {
      font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid #2a3560;
      background: var(--bg2); color: var(--text); cursor:pointer;
    }
    .btn:hover { background: var(--accent-weak); border-color: var(--accent); }

    .spinner-wrap { display:flex; gap:10px; align-items:center; justify-content:center; padding:24px; }
    .spinner { width:16px; height:16px; border-radius:50%; border:3px solid #263154; border-top-color:#b392ff; animation:spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .footer { text-align:center; color: var(--muted); padding: 26px 24px; font-size: 13px; }
    .footer a { color:#cdb8ff; }

  </style>
</head>
<body>
    <header>
    <div class="container">
      <div class="nav">
        <h1 style="margin-right:auto;">TREC BioGen 2025 — Task B Viewer</h1>
        <a href="#home">Home</a>
        <a href="#viewer">Viewer</a>
        <a href="https://github.com/cbsag/trec-biogen-taskb-viewer" target="_blank" rel="noopener">GitHub</a>
        <a href="https://www.linkedin.com/in/your-link" target="_blank" rel="noopener">LinkedIn</a>
      </div>
      <div class="hero" id="home">Search the 30 questions and compare answers across different systems.</div>
    </div>
  </header>

  <div class="container" id="viewer">
    <div class="panel">
      <div class="row">
        <div class="grow">
          <input id="q" type="text" placeholder="Search by ID, question, topic, or narrative… (e.g., 'axonal injury' or '181')" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="systems" id="systems"></div>
        <label class="chip" title="Automatically query PubMed for each sentence (rate-limited).">
          <input type="checkbox" id="autoCiteToggle" />
          <span>Auto‑cite sentences (PubMed)</span>
        </label>
      </div>
      <div class="muted" id="meta" style="margin-top:8px"></div>
    </div>

    <div id="results"></div>
  </div>

 <div class="footer">
  ~ cbsag ·
  <a href="https://github.com/cbsag" target="_blank" rel="noopener">GitHub</a> ·
  <a href="https://www.linkedin.com/in/your-link" target="_blank" rel="noopener">LinkedIn</a>
</div>

  <script>
    const systemsDiv = document.getElementById("systems");
    const resultsDiv = document.getElementById("results");
    const metaDiv = document.getElementById("meta");
    const qInput = document.getElementById("q");

    let allSystems = [];
    let sysDescriptions = {};
    let autoCite = false;
    const AUTO_CITE_PER_ANSWER_LIMIT = 5;  // limit per system answer card
    const AUTO_CITE_RETMAX = 3;             // top N PubMed matches per sentence

    function selectedSystems() {
      return Array.from(document.querySelectorAll('.chip input[type="checkbox"]:checked')).map(cb => cb.value);
    }

    function renderSystems() {
      systemsDiv.innerHTML = "";
      allSystems.forEach(sys => {
        const chip = document.createElement("label");
        chip.className = "chip";
        const desc = (sysDescriptions[sys]||"").replace(/"/g,'&quot;');
        chip.innerHTML = `
          <input type="checkbox" value="${sys}" checked />
          <span>${sys}</span>
          <span class="muted" title="${desc}">ⓘ</span>
        `;
        systemsDiv.appendChild(chip);
        chip.querySelector("input").addEventListener("change", doSearch);
      });
    }

    async function fetchSystems() {
      const r = await fetch("/api/systems");
      const data = await r.json();
      allSystems = data.systems || [];
      sysDescriptions = data.descriptions || {};
      renderSystems();
    }

    function splitSentences(text) {
      if (!text) return [];
      // Split by punctuation + whitespace while keeping abbreviations somewhat safe
      // This is a simple splitter; for biomedical text it's okay for UI purposes.
      const parts = text
        .replace(/\s+/g, ' ')
        .split(/(?<=[\.!?])\s+(?=[A-Z0-9])/g);
      return parts.filter(s => s && s.trim());
    }

    // async function fetchCites(sentence, retmax=5) {
    //   const url = `/api/cite?sentence=${encodeURIComponent(sentence)}&retmax=${retmax}`;
    //   const r = await fetch(url);
    //   if (!r.ok) throw new Error(`Citation search failed (${r.status})`);
    //   return await r.json();
    // }

    // function renderCitations(container, sentence, retmax=5) {
    //   container.innerHTML = '<span class="muted">searching…</span>';
    //   fetchCites(sentence, retmax).then(data => {
    //     if (!data.citations || !data.citations.length) {
    //       container.innerHTML = '<span class="muted">no PubMed matches</span>';
    //       return;
    //     }
    //     const ul = document.createElement('ul');
    //     ul.style.margin = '6px 0 0 0';
    //     ul.style.paddingLeft = '18px';
    //     data.citations.forEach(c => {
    //       const li = document.createElement('li');
    //       const link = document.createElement('a');
    //       link.href = c.url;
    //       link.target = '_blank';
    //       link.rel = 'noopener';
    //       link.textContent = `${c.title} (${c.journal}${c.year? ', ' + c.year : ''})`;
    //       li.appendChild(link);
    //       if (c.doi) {
    //         const small = document.createElement('span');
    //         small.className = 'muted';
    //         small.style.marginLeft = '6px';
    //         small.textContent = `doi:${c.doi}`;
    //         li.appendChild(small);
    //       }
    //       ul.appendChild(li);
    //     });
    //     container.innerHTML = '';
    //     container.appendChild(ul);
    //   }).catch(err => {
    //     container.innerHTML = '<span class="muted">error fetching citations</span>';
    //   });
    // }
    let _citeCache = new Map();    // front-end cache by exact sentence
    const RATE_MS = 120;           // ~8 req/s to stay <10 rps
    let _citeQ = Promise.resolve(); // queue to serialize bursts

      async function fetchCites(sentence, retmax=5) {
        const key = `${sentence}::${retmax}`;
        if (_citeCache.has(key)) return _citeCache.get(key);
        const url = `/api/cite?sentence=${encodeURIComponent(sentence)}&retmax=${retmax}`;
        // queue it to respect rate
        _citeQ = _citeQ.then(() => new Promise((resolve) => setTimeout(resolve, RATE_MS)));
        await _citeQ;
        const r = await fetch(url);
        const data = await r.json().catch(() => ({}));
        _citeCache.set(key, data);
        return data;
      }

      function renderCitations(container, sentence, retmax=5) {
        container.innerHTML = '<span class="muted">searching…</span>';
        fetchCites(sentence, retmax).then(data => {
          if (data.error) {
            container.innerHTML = `<span class="muted">error: ${data.error}</span>`;
            return;
          }
          if (!data.citations || !data.citations.length) {
            container.innerHTML = '<span class="muted">no PubMed matches</span>';
            return;
          }
          const ul = document.createElement('ul');
          ul.style.margin = '8px 0 0 0';
          ul.style.paddingLeft = '18px';
          data.citations.forEach(c => {
            const li = document.createElement('li');
            const link = document.createElement('a');
            link.href = c.url; link.target = "_blank"; link.rel = "noopener";
            link.textContent = `${c.title} (${c.journal}${c.year ? ', ' + c.year : ''})`;
            li.appendChild(link);
            if (c.doi) {
              const small = document.createElement('span');
              small.className = 'muted'; small.style.marginLeft = '6px';
              small.textContent = `doi:${c.doi}`;
              li.appendChild(small);
            }
            ul.appendChild(li);
          });
          container.innerHTML = ''; container.appendChild(ul);
        }).catch(err => {
          container.innerHTML = `<span class="muted">error: ${String(err.message || err)}</span>`;
        });
      }

    function renderResults(data) {
      resultsDiv.innerHTML = "";
      metaDiv.textContent = `${data.count} result(s) • showing: ${data.systems.join(", ")}`;

      data.results.forEach(item => {
        const wrap = document.createElement("div");
        wrap.className = "panel result";

        const header = document.createElement("div");
        header.innerHTML = `
          <div class="qid">ID ${item.id}</div>
          <div class="qt">${item.question}</div>
          <div class="topic">Topic: ${item.topic || "—"}</div>
        `;
        wrap.appendChild(header);

        const det = document.createElement("details");
        const sum = document.createElement("summary");
        sum.textContent = "Show narrative";
        det.appendChild(sum);
        const p = document.createElement("div");
        p.className = "muted";
        p.style.marginTop = "8px";
        p.textContent = item.narrative || "—";
        det.appendChild(p);
        wrap.appendChild(det);

        const answers = document.createElement("div");
        answers.className = "answers";
        Object.entries(item.answers).forEach(([sys, text]) => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="sys">${sys}</div>
            <div class="ans"></div>
          `;
          answers.appendChild(card);
          // Populate sentences with per-sentence citation search
          const ansDiv = card.querySelector('.ans');
          if (text) {
            const sents = splitSentences(text);
            sents.forEach((s, idx) => {
              const row = document.createElement('div');
              row.className = 'srow';
              const span = document.createElement('span');
              span.className = 'text';
              span.textContent = s;

              const actions = document.createElement('span');
              actions.className = 'actions';

              const btn = document.createElement('button');
              btn.className = 'btn';
              btn.textContent = 'Find PubMed cites';

              const slot = document.createElement('div');
              slot.className = 'muted';
              slot.style.marginTop = '6px';

              btn.addEventListener('click', () => renderCitations(slot, s, 5));

              actions.appendChild(btn);
              row.appendChild(span);
              row.appendChild(actions);
              row.appendChild(slot);
              ansDiv.appendChild(row);

              // Auto-cite (rate-limited)
              if (autoCite && idx < AUTO_CITE_PER_ANSWER_LIMIT) {
                renderCitations(slot, s, AUTO_CITE_RETMAX);
              }
            });
          } else {
            ansDiv.innerHTML = "<span class='muted'>— no answer —</span>";
          }
//           const ansDiv = card.querySelector('.ans');
//           if (text) {
//             const sents = splitSentences(text);
//             sents.forEach(s => {
//               const row = document.createElement('div');
//               row.style.marginBottom = '6px';
//               const span = document.createElement('span');
//               span.textContent = s;

//               const btn = document.createElement('button');
//               btn.textContent = 'Find PubMed cites';
//               btn.style.marginLeft = '8px';
//               btn.style.fontSize = '12px';
//               btn.style.padding = '2px 6px';
//               btn.style.borderRadius = '8px';
//               btn.style.border = '1px solid #263154';
//               btn.style.background = '#0e1430';
//               btn.style.color = 'var(--text)';
//               btn.style.cursor = 'pointer';

//               const slot = document.createElement('div');
//               slot.className = 'muted';
//               slot.style.fontSize = '12px';
//               slot.style.marginTop = '4px';

//               btn.addEventListener('click', () => {
//                 renderCitations(slot, s, 5);
//               });
//               row.appendChild(span);
//               row.appendChild(btn);
//               row.appendChild(slot);
//               ansDiv.appendChild(row);
//               // Auto-cite (rate-limited per card)
//               if (autoCite && ansDiv.childElementCount <= AUTO_CITE_PER_ANSWER_LIMIT) {
//                 renderCitations(slot, s, AUTO_CITE_RETMAX);
//               }
// });
//           } else {
//             ansDiv.innerHTML = "<span class='muted'>— no answer —</span>";
//           }
        });
        wrap.appendChild(answers);
        resultsDiv.appendChild(wrap);
      });
    }

    async function doSearch() {
      const q = qInput.value;
      const selected = selectedSystems();
      // resultsDiv.innerHTML = `<div class="spinner-wrap"><div class="spinner"></div><div class="muted">Loading answers…</div></div>`;
      resultsDiv.innerHTML = `<div class="spinner-wrap"><div class="spinner"></div><div class="muted">Loading answers…</div></div>`;

      const url = `/api/search?q=${encodeURIComponent(q)}&systems=${encodeURIComponent(selected.join(","))}`;
      const r = await fetch(url);
      const data = await r.json();
      renderResults(data);
    }

    qInput.addEventListener("input", () => {
      clearTimeout(window.__q_timer);
      window.__q_timer = setTimeout(doSearch, 120);
    });

    (async function init() {
      await fetchSystems();
      await doSearch();
      qInput.focus();
      const t = document.getElementById('autoCiteToggle');
      if (t) {
        const saved = localStorage.getItem('autoCite') === 'true';
        t.checked = saved; autoCite = saved;
        t.addEventListener('change', () => {
          autoCite = t.checked; localStorage.setItem('autoCite', String(autoCite));
          // re-run to annotate again if enabled
          doSearch();
        });
      }
    })();
  </script>
</body>
</html>
