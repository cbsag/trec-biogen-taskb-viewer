<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TREC BioGen 2025 â€” Task B</title>
  <style>
    /* ---------- THEME ---------- */
    :root{
      --bg:#0b0e16; --bg2:#0f1428; --card:#151c34; --text:#e8ecff; --muted:#a7b4dd;
      --line:#212b4f; --line2:#273463; --accent:#7c3aed; --accent-weak:#2e2058;
      --chip:#101739; --chip-bd:#2a3560; --pill:#211948; --pill-bd:#3c2d74;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --link:#eadcff; --link-hover:#ffffff;
    }
    /* [data-theme="light"]{
      --bg:#f6f7fb; --bg2:#f2f3f9; --card:#ffffff; --text:#1c2340; --muted:#5a6a99;
      --line:#e6e9f3; --line2:#dfe4f3; --accent:#6d28d9; --accent-weak:#efe9ff;
      --chip:#ffffff; --chip-bd:#e6e9f3; --pill:#ffffff; --pill-bd:#e6e9f3;
      --shadow: 0 8px 20px rgba(2,6,23,.08);
      --link:#4b2bb8; --link-hover:#2a167a;
    } */
     [data-theme="light"]{
      /* Softer, tinted light palette */
      --bg:#edf0f7;        /* page background */
      --bg2:#e9ecf5;       /* controls / inputs bg */
      --card:#f3f5fb;      /* panels/cards (no pure white) */
      --text:#1c2340;
      --muted:#5a6a99;

      --line:#d7dced;      /* borders */
      --line2:#cfd6ea;

      --accent:#6d28d9;
      --accent-weak:#e9e2ff;

      --chip:#f3f5fb;      /* chips/pills match card tone */
      --chip-bd:#d7dced;
      --pill:#f3f5fb;
      --pill-bd:#d7dced;

      --shadow: 0 8px 18px rgba(20,30,60,.08);

      /* link contrast in light */
      --link:#4b2bb8;
      --link-hover:#2a167a;
    }
    [data-theme="light"] .bgfx::before{ opacity:.75; }
    [data-theme="light"] .bgfx .wavy{ opacity:.45; }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      color:var(--text); background:var(--bg);
    }
    [data-theme="light"] .nav a.active{
      background: #ece6ff;        /* soft purple chip */
      border-color: #6d28d9;      /* accent border */
      color: #2a167a;             /* readable text */
      box-shadow: 0 0 0 3px rgba(109,40,217,.12) inset;
      font-weight: 600;
    }

    /* Hover state in light mode (keeps contrast) */
    [data-theme="light"] .nav a:hover{
      background:#f2edff;
      border-color:#a88df2;
      color:#2a167a;
    }

    /* Keyboard focus ring (both themes) */
    .nav a:focus-visible{
      outline:2px solid var(--accent);
      outline-offset:2px;
      border-radius:10px;
    }
    /* ---------- GLOBAL BACKGROUND ANIMATION (all pages) ---------- */
    .bgfx{position:fixed; inset:0; z-index:-2; overflow:hidden}
    .bgfx::before{
      content:""; position:absolute; inset:-20% -10% -10% -10%;
      background:
        radial-gradient(40% 60% at 20% 20%, #1b2050 0%, transparent 60%),
        radial-gradient(40% 50% at 80% 10%, #2a2160 0%, transparent 60%),
        radial-gradient(30% 60% at 60% 90%, #171d48 0%, transparent 60%),
        radial-gradient(20% 30% at 10% 85%, #2c114b 0%, transparent 60%);
      filter:blur(38px); animation:float 16s ease-in-out infinite alternate;
      opacity:.70;
    }
    .bgfx .wavy{
      position:absolute; inset:0; pointer-events:none;
      background:
        repeating-linear-gradient( to bottom,
          transparent 0 14px, rgba(124,58,237,.05) 14px 28px),
        radial-gradient(1200px 400px at -200px 50%, rgba(124,58,237,.12), transparent 70%),
        radial-gradient(1200px 400px at 120% 40%, rgba(124,58,237,.12), transparent 70%);
      -webkit-mask:
        linear-gradient(90deg, transparent 0 6%, #000 6% 11%, transparent 11% 17%,
                               #000 17% 22%, transparent 22% 28%, #000 28% 33%,
                               transparent 33% 67%, #000 67% 72%, transparent 72% 78%,
                               #000 78% 83%, transparent 83% 100%);
      animation:drift 22s linear infinite;
      opacity:.55;
    }
    @keyframes float{to{transform:translateY(-18px) scale(1.02)}}
    @keyframes drift{to{background-position:0 260px, 0 0, 0 0}}

    /* ---------- HEADER ---------- */
    header{
      position:sticky; top:0; z-index:10; border-bottom:1px solid var(--line);
      background:rgba(11,14,22,.65); backdrop-filter:blur(6px); transition:opacity .25s;
    }

    [data-theme="light"] header{background:rgba(255,255,255,.7)}
    header.hidden{opacity:0; pointer-events:none}
    .nav{max-width:1100px;margin:0 auto;padding:14px 20px;display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .nav h1{margin:0;font-size:18px;font-weight:700}
    .nav a{color:var(--muted);text-decoration:none;padding:6px 10px;border-radius:10px}
    .nav a.active{color:var(--text); background:var(--pill); border:1px solid var(--pill-bd)}
    .spacer{flex:1}
    .toggle{cursor:pointer;border:1px solid var(--line2);background:var(--chip);padding:6px 9px;border-radius:999px}

    /* ---------- CONTAINERS ---------- */
    .container{max-width:1100px;margin:0 auto;padding:16px 24px 24px}

    /* ---------- LANDING ---------- */
    #landing{min-height:72vh;display:flex;align-items:center;justify-content:center;position:relative}
    .hero{position:relative;text-align:center; margin-top:8vh}
    .hero h2{font-size:44px;margin:0 0 8px}
    .hero p{color:var(--muted);margin:0 0 22px}
    .cta{font-size:16px;padding:10px 16px;border-radius:12px;border:1px solid var(--line2);
         background:linear-gradient(90deg,#2b1e52,#291e68);color:#fff;cursor:pointer}
    [data-theme="light"] .cta{background:linear-gradient(90deg,#eae2ff,#efeaff); color:#41298d}
    .cta:hover{box-shadow:0 0 0 3px rgba(124,58,237,.25)}

    .footer{text-align:center;color:var(--muted);padding:28px 24px;font-size:13px}
    .footer a{color:var(--text);text-decoration:none}

    /* ---------- PANELS & FORMS ---------- */
    .panel{background:var(--card);border:1px solid var(--line2);border-radius:16px;padding:18px;margin-bottom:18px; box-shadow:var(--shadow)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line2);background:var(--bg2);color:var(--text)}
    input[type="text"]:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,.25); outline:none}
    .btn{font-size:14px;padding:9px 12px;border-radius:12px;border:1px solid var(--line2);background:var(--bg2);color:var(--text);cursor:pointer}
    .btn:hover{background:var(--accent-weak);border-color:var(--accent)}
    .muted{color:var(--muted);font-size:13px}

    .filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .filters .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--chip-bd);background:var(--chip)}
    .filters .chip input{accent-color:var(--accent)}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .select{border:1px solid var(--line2);background:var(--bg2);color:var(--text);border-radius:8px;padding:6px 8px}

    /* ---------- RESULTS (Viewer) ---------- */
    .result{border-top:1px solid var(--line);padding-top:16px;margin-top:16px}
    .qid{font-weight:700;font-size:12px;color:var(--muted)}
    .qt{font-size:18px;font-weight:800;margin:6px 0 4px}
    .topic{font-size:13px;color:var(--muted)}
    details{margin-top:8px} summary{cursor:pointer;color:var(--muted)}
    summary:hover{color:var(--text)}

    .answers{margin-top:14px}
    .card{background:var(--bg2);border:1px solid var(--line2);border-radius:12px;padding:14px}
    .sys{font-weight:800;margin-bottom:10px;font-size:13px}

    .ans{line-height:1.65}
    .srow{margin:10px 0;padding:10px 12px;background:var(--card);border:1px solid var(--line2);border-radius:10px}
    .srow .bullet{display:inline-block;width:8px;height:8px;border-radius:50%;background:#7c3aed;margin-right:8px;transform:translateY(-1px)}
    .srow .text{display:inline}
    .srow .pmids{display:flex;gap:6px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .pill{font-size:12px;border:1px solid var(--line2);background:var(--bg2);padding:3px 8px;border-radius:999px}

    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
    .tab{padding:6px 10px;border-radius:10px;border:1px solid var(--line2);background:var(--bg2);cursor:pointer}
    .tab.active{background:var(--pill);border-color:var(--accent)}
    .tabcontent{display:none}
    .tabcontent.active{display:block}

    .spinner-wrap{display:flex;gap:10px;align-items:center;justify-content:center;padding:24px}
    .spinner{width:16px;height:16px;border-radius:50%;border:3px solid var(--line2);border-top-color:#b392ff;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .citation-list{margin:10px 0 0 0; padding:0}
    .citation-card{list-style:none; margin:10px 0; padding:12px 12px; border:1px solid var(--line2);
                   background:var(--card); border-radius:10px}
    .citation-card a{color:var(--link); text-decoration:none}
    .citation-card a:hover{color:var(--link-hover); text-decoration:underline}
    .citation-card summary{color:var(--muted)}
    .absbox{margin-top:8px; padding:10px 12px; border-radius:10px; background:var(--bg2); border:1px solid var(--line2); white-space:pre-wrap}

    .link{color:var(--link);text-decoration:none}
    .link:hover{color:var(--link-hover);text-decoration:underline}

    /* --- Task page helpers --- */
    .codebox{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: var(--bg2); border: 1px solid var(--line2);
      border-radius: 12px; padding: 12px; overflow: auto; font-size: 13px; line-height: 1.5;
    }
    .badge{
      display:inline-block;padding:2px 8px;margin-left:8px;border-radius:999px;
      border:1px solid var(--line2); background:var(--bg2); font-size:12px; color:var(--muted)
    }

    .hide{display:none !important;}
  </style>
</head>
<body>
  <div class="bgfx"><div class="wavy"></div></div>

  <header id="siteHeader" class="hidden">
    <nav class="nav">
      <h1>TREC BioGen 2025 â€” Task B</h1>
      <!-- Use path links; SPA router will intercept -->
      <a href="/" id="navHome">Home</a>
      <a href="/task" id="navTask">Task</a>
      <a href="/viewer" id="navViewer">Viewer</a>
      <span class="spacer"></span>
      <a href="https://github.com/cbsag" target="_blank" rel="noopener">GitHub</a>
      <a href="https://www.linkedin.com/in/cbsag" target="_blank" rel="noopener">LinkedIn</a>
      <button class="toggle" id="themeToggle" title="Toggle light / dark">ðŸŒ™</button>
    </nav>
  </header>

  <!-- HOME / LANDING -->
  <section id="landing" class="container">
    <div class="hero">
      <h2 id="heroTitle">TREC BioGen 2025 â€” Task B</h2>
      <p>Generate answers for 30 medical questions and compare multiple systems.</p>
      <button class="cta" id="openViewerBtn">Open Viewer</button>
    </div>
  </section>

  <!-- TASK PAGE (focused on Task B) -->
  <section id="task" class="container hide">
    <div class="panel">
      <h2 style="margin:0 0 6px">Task B â€” Reference Attribution</h2>
      <p class="muted" style="margin:0 0 12px">
        Given a biomedical <b>topic (question)</b> and a stable PubMed snapshot, generate a short answer (â‰¤ 250 words).
        <b>Every sentence</b> in the answer may include up to <b>3 PubMed IDs (PMIDs)</b> that support that sentence. PMIDs must come
        from the released corpus snapshot. <span class="badge">Focus of this viewer</span>
      </p>

      <h3 style="margin:14px 0 8px">What you submit</h3>
      <ul>
        <li>One UTF-8 <b>JSONL</b> run. Each line corresponds to one topic.</li>
        <li>Each line contains <code>metadata</code> and a <code>responses</code> list (one entry per generated sentence).</li>
        <li>Per sentence: the <code>text</code> and up to <b>3</b> supporting <code>citations</code> (PMIDs). Order does not matter.</li>
        <li>Total answer length: <b>â‰¤ 250 words</b>.</li>
      </ul>

      <h3 style="margin:16px 0 8px">Run format (JSONL example)</h3>
      <div class="codebox"><pre>{
  "metadata": {
    "team_id": "your_team",
    "run_id": "yourteam-run-001",
    "topic_id": "181"
  },
  "responses": [
    { "text": "First sentence of your answer.", "citations": ["31604329", "22802756"] },
    { "text": "Second sentence of your answer.", "citations": ["30508923"] }
  ]
}</pre></div>

      <h3 style="margin:16px 0 8px">Timeline (BioGen 2025)</h3>
      <ul>
        <li><b>Dataset & Baseline:</b> June 2, 2025</li>
        <li><b>Submission deadline:</b> August 15, 2025</li>
        <li><b>Results:</b> late September 2025</li>
        <li><b>Notebook paper:</b> late October 2025</li>
        <li><b>TREC conference:</b> Nov 17â€“21, 2025</li>
      </ul>

      <p style="margin:10px 0 0">
        <a class="link" href="https://trec-biogen.github.io/docs/#task-description" target="_blank" rel="noopener">
          Official task page â†’
        </a>
      </p>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px">Task A â€” Grounding Answer (quick glance)</h3>
      <ul>
        <li>Input: a question and an existing answer sentence (with older supported PMIDs).</li>
        <li>Output: up to <b>3 new supporting PMIDs</b> and up to <b>3 contradicting PMIDs</b> per sentence (from the released corpus).</li>
        <li>Contradicting evidence is prioritized if both are found.</li>
      </ul>
    </div>
  </section>

  <!-- VIEWER -->
  <section id="viewer" class="container hide">
    <div class="panel">
      <div class="row">
        <div class="grow">
          <input id="q" type="text" placeholder="Search by ID, question, topic, or narrativeâ€¦ (e.g., â€˜axonal injuryâ€™ or â€˜181â€™)" />
        </div>
        <button class="btn" id="searchBtn">Search</button>
        <button class="btn" id="toggleFiltersBtn">Hide Filters</button>
      </div>

      <div id="filters" class="row" style="margin-top:10px">
        <div class="filters" id="systems"></div>

        <div class="toolbar">
          <label class="muted">View</label>
          <select id="viewMode" class="select">
            <option value="auto" selected>Auto (Tabs if multiple)</option>
            <option value="tabs">Tabs</option>
            <option value="columns">Columns</option>
          </select>

          <label class="muted">Text size</label>
          <select id="textSize" class="select">
            <option value="1.55">Comfort</option>
            <option value="1.65" selected>Relaxed</option>
            <option value="1.8">Spacious</option>
          </select>
        </div>
        <div class="muted" id="meta" style="margin-top:6px"></div>
      </div>

      <div id="results" class="panel" style="margin:12px 0 0 0">
        <div class="muted">Type a query and press <b>Search</b>.</div>
      </div>
    </div>
  </section>

  <div class="footer">~ cbsag Â· <a href="https://github.com/cbsag" target="_blank" rel="noopener">GitHub</a> Â·
    <a href="https://www.linkedin.com/in/cbsag" target="_blank" rel="noopener">LinkedIn</a></div>

  <script>
    /* ====== ELEMENTS ====== */
    const header = document.getElementById('siteHeader');
    const systemsDiv = document.getElementById("systems");
    const resultsDiv = document.getElementById("results");
    const metaDiv = document.getElementById("meta");
    const qInput = document.getElementById("q");
    const searchBtn = document.getElementById("searchBtn");
    const toggleFiltersBtn = document.getElementById("toggleFiltersBtn");
    const filtersWrap = document.getElementById("filters");
    const viewModeSel = document.getElementById('viewMode');
    const textSizeSel = document.getElementById('textSize');
    const navHome = document.getElementById('navHome');
    const navViewer = document.getElementById('navViewer');
    const navTask = document.getElementById('navTask');
    const openViewerBtn = document.getElementById('openViewerBtn');
    const heroTitle = document.getElementById('heroTitle');
    const themeToggle = document.getElementById('themeToggle');

    /* ====== THEME ====== */
    (function initTheme(){
      const saved = localStorage.getItem('theme') || 'dark';
      if (saved === 'light') document.documentElement.setAttribute('data-theme','light');
      themeToggle.textContent = document.documentElement.getAttribute('data-theme')==='light'?'â˜€ï¸':'ðŸŒ™';
      themeToggle.addEventListener('click', ()=>{
        const l = document.documentElement.getAttribute('data-theme')==='light';
        document.documentElement.setAttribute('data-theme', l? '' : 'light');
        localStorage.setItem('theme', l? 'dark':'light');
        themeToggle.textContent = l? 'ðŸŒ™':'â˜€ï¸';
      });
    })();

    /* ====== ROUTER (paths: /, /task, /viewer) ====== */
    function routeFromLocation(){
      const p = location.pathname.replace(/\/+$/,'').toLowerCase();
      if (p === '' || p === '/') return '#home';
      if (p.endsWith('/task')) return '#task';
      if (p.endsWith('/viewer')) return '#viewer';
      // fallback to hash (if someone keeps old links)
      const h = (location.hash||'').toLowerCase();
      if (h === '#task' || h === '#viewer') return h;
      return '#home';
    }
    function setActiveNav(route){
      navHome.classList.toggle('active', route==='#home');
      navTask.classList.toggle('active', route==='#task');
      navViewer.classList.toggle('active', route==='#viewer');
    }
    function showSection(route){
      document.getElementById('landing').classList.toggle('hide', route!=='#home');
      document.getElementById('task').classList.toggle('hide', route!=='#task');
      document.getElementById('viewer').classList.toggle('hide', route!=='#viewer');
      setActiveNav(route);
      header.classList.toggle('hidden', route==='#home' && !window.__interacted);
      window.scrollTo(0, 0);
    }
    function renderRoute(){ showSection(routeFromLocation()); }
    function navigate(path){
      history.pushState(null, '', path);
      renderRoute();
    }
    window.addEventListener('popstate', renderRoute);

    // Intercept nav clicks so we SPA without reloads
    [navHome, navTask, navViewer].forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        window.__interacted = true;
        header.classList.remove('hidden');
        navigate(a.getAttribute('href'));
      });
    });

    // Open Viewer button -> real page (/viewer)
    openViewerBtn.addEventListener('click', ()=>{
      window.__interacted = true;
      header.classList.remove('hidden');
      navigate('/viewer');
      qInput && qInput.focus({preventScroll:true});
    });

    // Reveal header after any interaction on Home
    document.addEventListener('wheel', ()=>{
      if (routeFromLocation()==='#home'){ window.__interacted=true; header.classList.remove('hidden'); }
    });
    document.addEventListener('keydown', (e)=>{
      if (e.key === '/') { window.__interacted=true; navigate('/viewer'); qInput?.focus(); e.preventDefault(); }
    });
    heroTitle.addEventListener('click', ()=>{ window.__interacted=true; header.classList.remove('hidden'); });

    /* ====== DATA (systems) ====== */
    let allSystems = [];
    let sysDescriptions = {};
    let systemsReady = false;

    async function fetchSystems() {
      const r = await fetch("/api/systems");
      const data = await r.json();
      allSystems = data.systems || [];
      sysDescriptions = data.descriptions || {};
      renderSystems();
      systemsReady = true;
    }
    async function ensureSystemsLoaded(){ if (!systemsReady) await fetchSystems(); }

    function renderSystems() {
      systemsDiv.innerHTML = "";
      allSystems.forEach(sys => {
        const chip = document.createElement("label");
        chip.className = "chip";
        const desc = (sysDescriptions[sys]||"").replace(/"/g,'&quot;');
        chip.innerHTML = `
          <input type="checkbox" value="${sys}" />
          <span>${sys}</span>
          <span class="muted" title="${desc}">â“˜</span>
        `;
        systemsDiv.appendChild(chip);
      });
    }
    function selectedSystems() {
      const boxes = Array.from(document.querySelectorAll('#systems input[type="checkbox"]'));
      const checked = boxes.filter(cb => cb.checked).map(cb => cb.value);
      return checked.length ? checked : allSystems.slice();
    }

    /* ====== VIEWER: Search ====== */
    function splitSentences(text) {
      if (!text) return [];
      const parts = text.replace(/\s+/g, ' ').split(/(?<=[\.!?])\s+(?=[A-Z0-9])/g);
      return parts.filter(s => s && s.trim());
    }

    async function doSearch() {
      await ensureSystemsLoaded();
      const q = qInput.value.trim();
      const selected = selectedSystems();
      if (!q) {
        resultsDiv.innerHTML = `<div class="muted">Type a query and press <b>Search</b>.</div>`;
        metaDiv.textContent = '';
        return;
      }
      resultsDiv.innerHTML = `<div class="spinner-wrap"><div class="spinner"></div><div class="muted">Loadingâ€¦</div></div>`;
      const url = `/api/search?q=${encodeURIComponent(q)}&systems=${encodeURIComponent(selected.join(","))}`;
      const r = await fetch(url);
      const data = await r.json();
      renderResults(data);
    }
    searchBtn.addEventListener('click', doSearch);
    qInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter') doSearch(); });

    toggleFiltersBtn.addEventListener('click', ()=>{
      const hide = !filtersWrap.classList.contains('hide');
      filtersWrap.classList.toggle('hide', hide);
      toggleFiltersBtn.textContent = hide ? 'Show Filters' : 'Hide Filters';
    });
    textSizeSel.addEventListener('change', ()=>{
      document.querySelectorAll('.ans').forEach(a => a.style.lineHeight = textSizeSel.value);
    });

    /* ====== PMIDs â†’ details (bottom section & per sentence) ====== */
    async function fetchPMIDsDetails(pmids) {
      const key = pmids.join(",");
      if (!window.__pmidCache) window.__pmidCache = new Map();
      if (window.__pmidCache.has(key)) return window.__pmidCache.get(key);
      const r = await fetch(`/api/pubmed?pmids=${encodeURIComponent(key)}`);
      const data = await r.json().catch(()=>({}));
      window.__pmidCache.set(key, data);
      return data;
    }
    function renderPMIDList(container, pmids) {
      container.innerHTML = '<span class="muted">loadingâ€¦</span>';
      fetchPMIDsDetails(pmids).then(data => {
        if (data.error) { container.innerHTML = `<span class="muted">error: ${data.error}</span>`; return; }
        if (!data.items || !data.items.length) { container.innerHTML = '<span class="muted">no details returned</span>'; return; }
        const ul = document.createElement('ul'); ul.className='citation-list';
        data.items.forEach(p => {
          const li = document.createElement('li'); li.className='citation-card';
          const a = document.createElement('a'); a.href = p.url; a.target='_blank'; a.rel='noopener';
          a.textContent = `${p.title} (${p.journal}${p.year ? ', ' + p.year : ''})`;
          li.appendChild(a);
          if (p.doi) {
            const d = document.createElement('div'); d.className='muted'; d.style.marginTop='4px'; d.textContent = `doi: ${p.doi}`; li.appendChild(d);
          }
          if (p.abstract) {
            const det = document.createElement('details');
            const sum = document.createElement('summary'); sum.textContent = 'Show abstract';
            const abs = document.createElement('div'); abs.className='absbox'; abs.textContent = p.abstract;
            det.appendChild(sum); det.appendChild(abs);
            li.appendChild(det);
          }
          ul.appendChild(li);
        });
        container.innerHTML = ''; container.appendChild(ul);
      }).catch(err => { container.innerHTML = `<span class="muted">error: ${String(err.message || err)}</span>`; });
    }

    function addPMIDsSection(card, pmids) {
      if (!pmids || !pmids.length) return;
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = `Cited PMIDs (${pmids.length})`;
      const slot = document.createElement('div');
      slot.className = 'muted'; slot.style.marginTop = '8px';
      btn.addEventListener('click', () => renderPMIDList(slot, pmids));
      card.appendChild(btn);
      card.appendChild(slot);
    }

    /* ====== VIEWER: Render ====== */
    function renderResults(data) {
      resultsDiv.innerHTML = "";
      metaDiv.textContent = `${data.count} result(s) â€¢ showing: ${data.systems.join(", ")}`;

      data.results.forEach(item => {
        const wrap = document.createElement("div");
        wrap.className = "panel result";

        const header = document.createElement("div");
        header.innerHTML = `
          <div class="qid">ID ${item.id}</div>
          <div class="qt">${item.question}</div>
          <div class="topic">Topic: ${item.topic || "â€”"}</div>
        `;
        wrap.appendChild(header);

        const det = document.createElement("details");
        const sum = document.createElement("summary"); sum.textContent = "Show narrative";
        const p = document.createElement("div"); p.className = "muted"; p.style.marginTop = "8px"; p.textContent = item.narrative || "â€”";
        det.appendChild(sum); det.appendChild(p); wrap.appendChild(det);

        const answersWrap = document.createElement("div"); answersWrap.className = "answers";

        // systems that have non-empty answers
        const sysList = Object.entries(item.answers)
            .filter(([_, obj]) => obj && (obj.text || (obj.sentences && obj.sentences.length)));
        const multi = sysList.length > 1;
        const mode = (viewModeSel.value === 'auto') ? (multi ? 'tabs' : 'single') : viewModeSel.value;

        function populateCard(cardBody, ansObj, sysName){
          const sents = ansObj.sentences && ansObj.sentences.length
            ? ansObj.sentences.map(x => ({t:x.text, pmids:x.pmids||[]}))
            : splitSentences(ansObj.text).map(t => ({t, pmids:[]}));

          cardBody.style.lineHeight = textSizeSel.value;
          sents.forEach(({t, pmids})=>{
            const row = document.createElement('div'); row.className = 'srow';
            const dot = document.createElement('span'); dot.className = 'bullet';
            const span = document.createElement('span'); span.className = 'text'; span.textContent = t;
            row.appendChild(dot); row.appendChild(span);

            if (pmids && pmids.length){
              const pm = document.createElement('div'); pm.className='pmids';
              const label = document.createElement('span'); label.className='muted'; label.textContent = 'PMIDs:';
              pm.appendChild(label);
              pmids.slice(0,3).forEach(id=>{
                const chip = document.createElement('a'); chip.className='pill'; chip.target="_blank";
                chip.rel='noopener'; chip.href=`https://pubmed.ncbi.nlm.nih.gov/${id}/`; chip.textContent=id;
                pm.appendChild(chip);
              });
              const btn = document.createElement('button'); btn.className='btn'; btn.style.padding='3px 8px'; btn.textContent='Show refs';
              const slot = document.createElement('div'); slot.className='muted'; slot.style.marginTop='6px';
              btn.addEventListener('click', ()=> renderPMIDList(slot, pmids));
              pm.appendChild(btn); row.appendChild(pm); row.appendChild(slot);
            }
            cardBody.appendChild(row);
          });

          if (ansObj.pmids_all && ansObj.pmids_all.length) {
            addPMIDsSection(cardBody.parentElement, ansObj.pmids_all);
          } else if (item.pmids && item.pmids[sysName] && item.pmids[sysName].length) {
            addPMIDsSection(cardBody.parentElement, item.pmids[sysName]);
          }
        }

        if (!multi || mode === 'single') {
          const [sys, ansObj] = sysList[0] || ["System", {text:""}];
          const card = document.createElement("div"); card.className = "card";
          card.innerHTML = `<div class="sys">${sys}</div><div class="ans"></div>`;
          answersWrap.appendChild(card);
          populateCard(card.querySelector('.ans'), ansObj, sys);

        } else if (mode === 'tabs') {
          const tabs = document.createElement('div'); tabs.className = 'tabs';
          const contents = document.createElement('div');
          sysList.forEach(([sys, ansObj], idx)=>{
            const t = document.createElement('button'); t.className = 'tab' + (idx===0 ? ' active' : ''); t.textContent = sys;
            tabs.appendChild(t);
            const c = document.createElement('div'); c.className = 'tabcontent' + (idx===0 ? ' active' : '');
            const card = document.createElement('div'); card.className='card';
            card.innerHTML=`<div class="sys">${sys}</div><div class="ans"></div>`;
            c.appendChild(card); contents.appendChild(c);
            populateCard(card.querySelector('.ans'), ansObj, sys);
            t.addEventListener('click', ()=>{
              tabs.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
              contents.querySelectorAll('.tabcontent').forEach(x=>x.classList.remove('active'));
              t.classList.add('active'); c.classList.add('active');
            });
          });
          answersWrap.appendChild(tabs); answersWrap.appendChild(contents);

        } else { // columns
          const grid = document.createElement('div');
          grid.style.display = 'grid';
          grid.style.gridTemplateColumns = `repeat(${Math.min(sysList.length, 3)}, minmax(320px, 1fr))`;
          grid.style.gap = '16px';
          sysList.forEach(([sys, ansObj])=>{
            const card = document.createElement('div'); card.className = 'card';
            card.innerHTML = `<div class="sys">${sys}</div><div class="ans"></div>`;
            grid.appendChild(card);
            populateCard(card.querySelector('.ans'), ansObj, sys);
          });
          answersWrap.appendChild(grid);
        }

        wrap.appendChild(answersWrap);
        resultsDiv.appendChild(wrap);
      });
    }

    /* ====== INIT ====== */
    (async function init(){
      await fetchSystems();
      // Activate SPA routing & initial render
      renderRoute();
    })();
  </script>
</body>
</html>
